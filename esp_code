#define BLYNK_TEMPLATE_ID "TMPL3wVUfm6Wi"
#define BLYNK_TEMPLATE_NAME "BlindStick"
#define BLYNK_AUTH_TOKEN "SP9mtNZ76o_R2fQyhWdVlqEI9j5YVsGz"


#include <WiFi.h>
#include <BlynkSimpleEsp32.h>


// ---------- WiFi ----------
char ssid[] = "realme";  
char pass[] = "realmenarzo";


// ---------- Blynk ----------
BlynkTimer timer;


// ---------- ULTRASONIC SENSOR ----------
#define TRIG_PIN 5
#define ECHO_PIN 19
#define BUZZER_PIN 4


// ---------- BUTTONS ----------
#define BUTTON1_PIN 15   // original button for Blynk email
#define BUTTON2_PIN 2    // new button for continuous LED + buzzer


// ---------- LED ----------
#define LED_PIN 13       // new LED to blink continuously


// ---------- VARIABLES ----------
int distance;
unsigned long lastEventTime1 = 0;
bool lastButtonState1 = HIGH;
bool lastButtonState2 = HIGH;


// Beep-beep pattern variables
unsigned long lastBeepTime = 0;
bool buzzerState = false;
int beepInterval = 0;


// LED + buzzer continuous action variables
bool continuousAction = false;
unsigned long actionStartTime = 0;
bool ledState = false;


void setup() {
  Serial.begin(115200);


  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(BUTTON1_PIN, INPUT_PULLUP);
  pinMode(BUTTON2_PIN, INPUT_PULLUP);
  pinMode(LED_PIN, OUTPUT);


  Serial.println("Connecting to WiFi...");
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
  Serial.println("Connected to Blynk!");


  // Timer for distance measurement and beep pattern
  timer.setInterval(100L, []() {
    distance = getDistance();
    if (distance == -1) {
      Serial.println("Out of range or no echo.");
      beepInterval = 0;
      digitalWrite(BUZZER_PIN, LOW);
    } else {
      Serial.print("Distance: ");
      Serial.print(distance);
      Serial.println(" cm");


      // Set beep interval based on distance
      if (distance <= 10)        beepInterval = 100;  // very fast
      else if (distance <= 20)  beepInterval = 300;  // fast
      else if (distance <= 30)  beepInterval = 500;  // medium
      else if (distance <= 40)  beepInterval = 800;  // slow
      else                       beepInterval = 0;   // off
    }
  });
}


void loop() {
  Blynk.run();
  timer.run();


  unsigned long currentMillis = millis();


  // --- Handle beep-beep pattern ---
  if (!continuousAction && beepInterval > 0) {
    if (currentMillis - lastBeepTime >= beepInterval) {
      buzzerState = !buzzerState;
      digitalWrite(BUZZER_PIN, buzzerState ? HIGH : LOW);
      lastBeepTime = currentMillis;
    }
  } else if (!continuousAction) {
    digitalWrite(BUZZER_PIN, LOW);
  }


  // --- Handle continuous action for LED + buzzer ---
  if (continuousAction) {
    // Blink LED every 200ms
    if (currentMillis - lastBeepTime >= 200) {
      ledState = !ledState;
      digitalWrite(LED_PIN, ledState ? HIGH : LOW);
      digitalWrite(BUZZER_PIN, HIGH); // Buzzer ON continuously
      lastBeepTime = currentMillis;
    }


    // Stop after 5 seconds
    if (currentMillis - actionStartTime >= 5000) {
      continuousAction = false;
      digitalWrite(LED_PIN, LOW);
      digitalWrite(BUZZER_PIN, LOW);
    }
  }


  // --- Button 1: send Blynk email ---
  bool currentButtonState1 = digitalRead(BUTTON1_PIN);
  if (lastButtonState1 == HIGH && currentButtonState1 == LOW) {
    if (currentMillis - lastEventTime1 > 5000) {  // debounce 5 sec
      Serial.println("Button 1 Pressed! Sending Alert via Blynk...");
      sendAlert();
      lastEventTime1 = currentMillis;
    }
  }
  lastButtonState1 = currentButtonState1;


  // --- Button 2: trigger continuous LED + buzzer ---
  bool currentButtonState2 = digitalRead(BUTTON2_PIN);
  if (lastButtonState2 == HIGH && currentButtonState2 == LOW) {
    if (!continuousAction) {
      Serial.println("Button 2 Pressed! Starting Continuous LED + Buzzer for 5 seconds...");
      continuousAction = true;
      actionStartTime = currentMillis;
      ledState = true;
      digitalWrite(LED_PIN, HIGH);
      digitalWrite(BUZZER_PIN, HIGH);
      lastBeepTime = currentMillis;
    }
  }
  lastButtonState2 = currentButtonState2;
}


// ---------- Measure Distance ----------
int getDistance() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);


  long duration = pulseIn(ECHO_PIN, HIGH, 30000);
  if (duration == 0) return -1;


  int dist = duration * 0.034 / 2;
  return dist;
}


// ---------- Blynk Email ----------
void sendAlert() {
  Blynk.logEvent("help_alert", "Help needed...!! Location: https://maps.app.goo.gl/rAt3Uz3f6QqsiV8PA");
  Serial.println("Blynk Event Triggered: Help Email Sent!");
}



